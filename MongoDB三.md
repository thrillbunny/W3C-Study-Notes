# MongoDB 复习三 - 升级

---
本篇是对[MongoDB的基本特性与内部构造的讲解](https://www.jb51.net/article/158096.htm)的摘录。

MongoDB 是是非关系数据库当中功能最丰富，最像关系数据库的。它支持的数据结构非常松散，是基于 json 改编的 bson 格式，因此可以存储比较复杂的数据类型。

MongoDB 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。（也很复杂，我用起来不是很习惯那种查询方式）

### BSON

在 MongoDB 中，**文档是对数据的抽象**，它被使用在 Client 端和 Server 端的交互中。所有的 Client 端（各种语言的 Driver）都会使用这种抽象，它的表现形式就是我们常说的 BSON（Binary JSON）。

BSON 是一个轻量级的二进制数据格式。MongoDB 能够使用 BSON，并将 BSON 作为数据的存储存放在磁盘中。

当 Client 端要将写入文档，使用查询等操作时，需要将文档编码为 BSON 格式，然后再发送给 Server 端。同样，Server 端的返回结果也是编码为 BSON 格式再返回给 Client 端的。

使用 BSON 的三种优势：

1）效率，BSON 是为效率而设计的，它只需要使用很少的空间。即使在最坏的情况下，BSON 格式也比 JSON 格式在最好的情况下存储效率高；

2）传输性，在某些情况下，BSON 会牺牲额外的空间让数据的传输更加方便。比如，字符串的传输**前缀**会标识字符串的长度，而不是在字符串的末尾打上结束的标记，这样的传输形式有利于 MongoDB 修改传输的数据（类似于 seek，更加容易定位）；

3）性能，BSON 格式的编码和解码都是非常快速的，它使用了 C 风格的数据表现形式，这样在各种语言中都可以高效地使用。

### 写入协议

Client 端访问 Server 端使用了轻量级的 TCP/IP 写入协议。这种协议在 MongoDB Wiki 中有详细介绍，它其实是在 BSON 数据上面做了一层简单的包装。比如说，写入数据的命令中包含了1个20字节的消息头（由消息的长度和写入命令标识组成）、需要写入的 Collection 名称和需要写入的数据。

### 数据文件

指的是在 MongoDB 的数据文件夹中（默认路径是/data/db）构成数据库的所有文件。每一个数据库都包含一个 **.ns** 文件和一些数据文件，其中数据文件会随着**数据量的增加**而变多。所以如果有一个数据库名字叫做 foo，那么构成 foo 这个数据库的文件就会由 foo.ns，foo.0，foo.1，foo.2 等等组成。

数据文件每新增一次，大小都会是上一个数据文件的**2**倍，每个数据文件最大2G。这样的设计有利于防止数据量较小的数据库浪费过多的空间，同时又能保证数据量较大的数据库有相应的空间使用。

MongoDB 会使用**预分配**方式来保证写入性能的稳定（这种方式可以使用 –noprealloc 关闭）。预分配在后台进行，并且每个预分配的文件都用0进行填充，这会让 MongoDB 始终保持额外的空间和空余的数据文件，从而避免了数据增长过快而带来的分配磁盘空间引起的**阻塞**。

### 名字空间和盘区

每一个数据库都由**多个名字空间**组成，每一个名字空间存储了相应类型的数据。数据库中的每一个 Collection 和索引文件都有各自对应的名字空间，所有名字空间的元数据都存储在16M的 .ns 文件中，平均每个命名占用约628字节，也即整个数据库的命名空间的上限约为24000。

如果每个集合有一个索引（比如默认的 _id 索引），那么最多可以创建12000个集合。如果索引数更多，则可创建的集合数就更少了。同时，如果集合数太多，一些操作也会变慢。

要建立更多的集合的话，MongoDB 也是支持的，只需要在启动时加上 “--nssize” 参数，这样对应数据库的命名空间文件就可以变得更大以便保存更多的命名。这个命名空间文件（.ns文件）最大可以为 2G。

名字空间中的数据在磁盘中分为多个区间，这个叫做盘区。

每一个名字空间可以包含多个不同的盘区，这些盘区并不是连续的，与数据文件的增长相同，每一个名字空间对应的盘区大小的也是随着分配的次数**不断增长**的。这样做的目的是为了平衡名字空间浪费的空间，保持某一个名字空间中数据的连续性。

还有一个需要注意的名字空间：$freelist，这个名字空间用于记录不再使用的盘区（被删除的 Collection 或索引）。每当名字空间需要分配新的盘区的时候，都会先查看$freelist是否有大小合适的盘区可以使用。


### 内存映射存储引擎

MongoDB 目前支持的存储引擎为**内存映射引擎**。当 MongoDB 启动的时候，会将**所有**的数据文件映射到内存中，然后操作系统会托管所有的磁盘操作。

这种存储引擎有以下几种特点：

- MongoDB 中关于内存管理的代码非常精简，相关的工作已经有操作系统进行托管

- MongoDB 服务器使用的虚拟内存将非常巨大，并将超过整个数据文件的大小。不用担心，操作系统会去处理这一切。要注意的是，MongoDB 自己是不管理内存的，无法指定内存大小，完全交给操作系统来管理，因此有时候是不可控的，在生产环境使用必须在 OS 层面监控内存使用情况。

- MongoDB 无法控制数据写入磁盘的顺序，这样将导致 MongoDB 无法实现 writeahead 日志的特性。所以，如果 MongoDB 希望提供一种 durability 的特性，需要实现另外一种存储引擎。

- 32位系统的 MongoDB 服务器每一个 Mongod 实例只能使用 2G 的数据文件。这是由于地址指针只能支持 32 位。